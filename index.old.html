<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <link rel="stylesheet" type="text/css" href="main.css">

    <script src="./node_modules/web3/dist/web3.min.js"></script>

</head>
<body onload="loadOperation()">
    <div class="container">

        <h1>PoC Energia</h1>
        
        <div id="operations">
			<a href="data.html">Consultar información de la Blockchain</a>
            <label for="selectOperation" class="col-lg-2 control-label">Operacion a ejecutar</label>
            <select id="operationsSelect" name="operationsSelect" onchange="loadOperation()">
                <option value="addUser">Anadir usuario</option>
                <option value="produceEnergy">Producir energia</option>
                <option value="purchaseEnergy">Comprar energia</option>
				<option value="consumeEnergy">Consumir energia</option>
				<option value="setPrize">Establecer precio</option>
			</select>
        </div>
        
        <div class="operation">
            <div id="users">
                <label for="userAddress" class="col-lg-2 control-label">Introducir cuenta</label>
                <input id="userAddress" type="text">

                <label for="userName" class="col-lg-2 control-label">Nombre del usuario</label>
                <input id="userName" type="text">

                <label for="userProfile" class="col-lg-2 control-label">Perfil del usuario</label>
                <select id="userProfiles" name="userProfiles">
                    <option selected value="producer">Productor</option>
                    <option value="distributor">Distribuidor</option>
                    <option value="purchase">Cliente</option>
                </select>
            </div>

            <div id="producedEner">
                    <label for="producedEnerQuantity" class="col-lg-2 control-label">Cantidad de energía producica</label>
                    <input id="producedEnerQuantity" type="text">

                    <label for="producedEnerDate" class="col-lg-2 control-label">Fecha</label>
                    <input id="producedEnerDate" type="date">
            </div>

            <div id="purchasedEner">
                    <label for="purchasedEnerQuantity" class="col-lg-2 control-label">Cantidad de energía comprada</label>
                    <input id="purchasedEnerQuantity" type="text">

                    <label for="purchasedValue" class="col-lg-2 control-label">Precio de compra</label>
                    <input id="purchasedValue" type="text">
        
                    <label for="productorAccount" class="col-lg-2 control-label">Dirección del productor</label>
                    <input id="productorAccount" type="text">   
                    
                    <label for="purchasedEnerDate" class="col-lg-2 control-label">Fecha</label>
                    <input id="purchasedEnerDate" type="date">
            </div>

            <div id="consumedEner">
                    <label for="consumedEnerQuantity" class="col-lg-2 control-label">Cantidad de energía consumida</label>
                    <input id="consumedEnerQuantity" type="text">

                    <label for="consumedConcept" class="col-lg-2 control-label">Concepto (razón del consumo)</label>
                    <input id="consumedConcept" type="text">

                    <label for="consumedValue" class="col-lg-2 control-label">Precio de la energía consumida</label>
                    <input id="consumedValue" type="text">
        
                    <label for="distributorAccount" class="col-lg-2 control-label">Dirección del distribuidor</label>
                    <input id="distributorAccount" type="text">

                    <label for="consumedEnerDate" class="col-lg-2 control-label">Fecha</label>
                    <input id="consumedEnerDate" type="date">
			</div>
			
			<div id="setPrize">
				<label for="prize" class="col-lg-2 control-label">Precio de la energía</label>
				<input id="prize" type="text">
		</div>
        </div>

        <div>
            <button id="button">Ejecutar operación</button>
        </div>

        <div id="accounts">
                <label for="selectAccount" class="col-lg-2 control-label">Cuenta que ejecutará la operación</label>
                <select id="accountsSelect" name="accountsSelect"/>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

    <script>
        function loadOperation(){
            myselect = document.getElementById("operationsSelect");
            operation = myselect.options[myselect.selectedIndex].value;
            if (operation=="addUser"){
                divUsers = document.getElementById("users");
                divUsers.style.display = "inline";
                divProduced = document.getElementById("producedEner");
                divProduced.style.display = "none";
                divPurchased = document.getElementById("purchasedEner");
                divPurchased.style.display = "none";
                divConsumed = document.getElementById("consumedEner");
                divConsumed.style.display = "none";
				divPrize = document.getElementById("setPrize");
                divPrize.style.display = "none";
            }else if(operation=="produceEnergy"){
                divProduced = document.getElementById("producedEner");
                divProduced.style.display = "inline";
                divUsers = document.getElementById("users");
                divUsers.style.display = "none";
                divPurchased = document.getElementById("purchasedEner");
                divPurchased.style.display = "none";
                divConsumed = document.getElementById("consumedEner");
                divConsumed.style.display = "none";
				divPrize = document.getElementById("setPrize");
                divPrize.style.display = "none";
            }else if(operation=="purchaseEnergy"){
                divPurchased = document.getElementById("purchasedEner");
                divPurchased.style.display = "inline";
                divProduced = document.getElementById("producedEner");
                divProduced.style.display = "none";
                divUsers = document.getElementById("users");
                divUsers.style.display = "none";
                divConsumed = document.getElementById("consumedEner");
                divConsumed.style.display = "none";
				divPrize = document.getElementById("setPrize");
                divPrize.style.display = "none";
            }else if(operation=="consumeEnergy"){
                divConsumed = document.getElementById("consumedEner");
                divConsumed.style.display = "inline";
                divProduced = document.getElementById("producedEner");
                divProduced.style.display = "none";
                divPurchased = document.getElementById("purchasedEner");
                divPurchased.style.display = "none";
                divUsers = document.getElementById("users");
                divUsers.style.display = "none";
				divPrize = document.getElementById("setPrize");
                divPrize.style.display = "none";
            }else if(operation=="setPrize"){
                divPrize = document.getElementById("setPrize");
                divPrize.style.display = "inline";
                divProduced = document.getElementById("producedEner");
                divProduced.style.display = "none";
                divPurchased = document.getElementById("purchasedEner");
                divPurchased.style.display = "none";
                divUsers = document.getElementById("users");
                divUsers.style.display = "none";
				divConsumed = document.getElementById("consumedEner");
                divConsumed.style.display = "none";
            }

        }
    </script>

    <script>
		//Definicion del nodo / proveedor de servicios
       if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            //web3 = new Web3(new Web3.providers.HttpProvider("http://ethpocmtcxle.westeurope.cloudapp.azure.com:8545"));
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            //web3 = new Web3(new Web3.providers.HttpProvider("http://192.168.23.128:8545"));
        }

		//Cogemos todas las cuentas de nuestro nodo
        accountNum = web3.eth.accounts.length;
        select = document.getElementById('accountsSelect');
        for (i = 0; i < accountNum; i++) {
            opt = document.createElement('option');
            opt.value = i;
            opt.innerHTML = web3.eth.accounts[i];
            select.appendChild(opt);
        }

		//Definimos cuenta con la que vamos a trabajar
        web3.eth.defaultAccount = web3.eth.accounts[0];
        //web3.eth.defaultAccount.gas = '3';


		//TRATAMIENTO DE LOS BLOQUES
		var filter = web3.eth.filter('latest');
		filter.watch(function(error, result){
			if (error) {
				alert("tratarBloques - error");			
				console.log(error);
				return;
			}else{
				alert("tratarBloques - bien");
				var block = web3.eth.getBlock(result, true);
				console.log('block #' + block.number);

				console.dir(block.transactions);
			}
			//for (var index = 0; index < block.transactions.length; index++) {
			//	var t = block.transactions[index];
			//}
		});

		filter.watch(function(error, result){
			if (error) {
				alert("Errorrrrrr");
				return;
			}else{
				console.log("Rrrrrresultado: " + result);
				alert("Resultado: " + result);
			}
		});

		var i = 1;
		//while (i<108) {
			i++;

			var block = web3.eth.getBlock(i, true);

			for (var index = 0; index < block.transactions.length; index++) {
				var t = block.transactions[index];
				alert(t.from);
			}

			/*web3.eth.getBlock(i, function(error, result){
				if(!error && result!=null){
					if (result.transactions.length!=0){
						console.log("Bloque: " + i + " - transacciones: " + result.transactions.length);
						var t = result.transactions[0];
						alert(t);
						// Decode from
						alert(t.from);
					}
				}
				else{
					alert("error");
					console.error(error);
				}
			});*/
		//}


		//DEFINICION DE LA INTERFAZ DEL SMART CONTRACT
        var PoCEnergyContract = web3.eth.contract([
	{
		"constant": true,
		"inputs": [],
		"name": "getUsers",
		"outputs": [
			{
				"name": "",
				"type": "address[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "userAccts",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getProducedEnergies",
		"outputs": [
			{
				"name": "",
				"type": "uint256[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "date",
				"type": "uint256"
			}
		],
		"name": "getPurchasedEner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "consumedDates",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_producer",
				"type": "address"
			},
			{
				"name": "_quantity",
				"type": "uint256"
			},
			{
				"name": "_value",
				"type": "uint256"
			},
			{
				"name": "_date",
				"type": "uint256"
			}
		],
		"name": "setPurchasedEnergy",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "date",
				"type": "uint256"
			}
		],
		"name": "getProducedEner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_address",
				"type": "address"
			},
			{
				"name": "_name",
				"type": "string"
			},
			{
				"name": "_profile",
				"type": "string"
			}
		],
		"name": "setUser",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "setPrize",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "usr",
				"type": "address"
			}
		],
		"name": "getUser",
		"outputs": [
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_quantity",
				"type": "uint256"
			},
			{
				"name": "_date",
				"type": "uint256"
			}
		],
		"name": "setProducedEnergy",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "purchasedDates",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "producedDates",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "usr",
				"type": "address"
			}
		],
		"name": "getUserProfile",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "date",
				"type": "uint256"
			}
		],
		"name": "getConsumedEner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_distributor",
				"type": "address"
			},
			{
				"name": "_quantity",
				"type": "uint256"
			},
			{
				"name": "_value",
				"type": "uint256"
			},
			{
				"name": "_concept",
				"type": "string"
			},
			{
				"name": "_date",
				"type": "uint256"
			}
		],
		"name": "setConsumedEnergy",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getPrize",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getPurchasedEnergies",
		"outputs": [
			{
				"name": "",
				"type": "uint256[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getConsumedEnergies",
		"outputs": [
			{
				"name": "",
				"type": "uint256[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "how",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "quantity",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "date",
				"type": "uint256"
			}
		],
		"name": "eventProduceEnergy",
		"type": "event"
	}
]);


        var PoCEnergy = PoCEnergyContract.at('0xb5862b687a7405bb47ebce93ae964c68cde3ef9e');
        console.log(PoCEnergy);

        
        PoCEnergy.getUsers(function(error, result){
            if(!error)
                {
                    //$("#instructor").html(result[0]+' ('+result[1]+' years old)');
                    //alert(result);
                    console.log(result);
                }
            else
                console.error(error);
        });

		//Definimos todas las funciones
        $("#button").click(function() {
			myselect = document.getElementById("operationsSelect");
            operation = myselect.options[myselect.selectedIndex].value;

			if (operation=="setPrize"){
				alert("Establacer precio");
				PoCEnergy.setPrize($("#prize").val());
			}else if(operation=="addUser"){
				alert("Añadir usuario");
				myselect = document.getElementById("userProfiles");
            	profile = myselect.options[myselect.selectedIndex].value;
            	alert($("#userAddress").val() + " - " + $("#userName").val() + " - " + profile);
            	PoCEnergy.setUser($("#userAddress").val(), $("#userName").val(), profile);
			}

		/*PoCEnergy.getPrize(function(error, result){
				if(!error)
					{
						//$("#instructor").html(result[0]+' ('+result[1]+' years old)');
						alert(result);
						console.log(result);
					}
				else{
					alert(error);
					console.error(error);
				}
			});*/			

			//alert(PoCEnergy.getUsers());
        });


    </script>



</body>
</html>